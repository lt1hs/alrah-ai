<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LiveKit Test</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.7/dist/livekit-client.umd.min.js"></script>
</head>
<body>
    <h1>LiveKit Connection Test</h1>
    <button id="test">Test LiveKit Connection</button>
    <div id="log"></div>

    <script>
        const log = document.getElementById('log');
        
        function addLog(message) {
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(div);
            console.log(message);
        }

        function waitForLiveKit() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function check() {
                    attempts++;
                    if (typeof LiveKit !== 'undefined' && LiveKit.Room) {
                        addLog('✅ LiveKit library loaded successfully');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('LiveKit library failed to load after 5 seconds'));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        document.getElementById('test').addEventListener('click', async () => {
            try {
                addLog('Checking LiveKit library...');
                await waitForLiveKit();
                
                addLog('Getting token...');
                
                const response = await fetch('http://91.109.114.158:8000/livekit/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'test_user' })
                });
                
                const data = await response.json();
                addLog(`Token received: ${data.token.substring(0, 20)}...`);
                addLog(`LiveKit URL: ${data.livekit_url}`);
                
                addLog('Creating LiveKit room...');
                const room = new LiveKit.Room();
                
                room.on(LiveKit.RoomEvent.Connected, () => {
                    addLog('✅ Connected to LiveKit successfully!');
                });
                
                room.on(LiveKit.RoomEvent.Disconnected, () => {
                    addLog('Disconnected from LiveKit');
                });
                
                room.on(LiveKit.RoomEvent.ConnectionStateChanged, (state) => {
                    addLog(`Connection state: ${state}`);
                });
                
                addLog('Connecting to LiveKit...');
                await room.connect(data.livekit_url, data.token);
                
                setTimeout(() => {
                    room.disconnect();
                    addLog('Test completed - disconnecting');
                }, 3000);
                
            } catch (error) {
                addLog(`❌ Error: ${error.message}`);
                console.error('Full error:', error);
            }
        });

        // Check if LiveKit is available on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof LiveKit !== 'undefined') {
                    addLog('LiveKit library detected on page load');
                } else {
                    addLog('⚠️ LiveKit library not detected - trying alternative CDN...');
                    
                    // Try alternative CDN
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/livekit-client@2.5.7/dist/livekit-client.umd.js';
                    script.onload = () => addLog('Alternative CDN loaded');
                    script.onerror = () => addLog('❌ Alternative CDN also failed');
                    document.head.appendChild(script);
                }
            }, 1000);
        });
    </script>
</body>
</html>
